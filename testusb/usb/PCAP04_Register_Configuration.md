# PCAP04 配置寄存器说明文档

## 概述
PCAP04是一款电容数字转换器（CDC）芯片，通过64个配置寄存器（Reg 0 ~ Reg 63）进行功能配置。

## 配置数组

### 标准配置（PCAP04_Config）
```c
unsigned char PCAP04_Config[] = {
 0x1D, 0x00, 0x58, 0x10,  // Reg 0-3
 0x10, 0x00, 0x3F, 0x20,  // Reg 4-7
 0x00, 0xD0, 0x07, 0x00,  // Reg 8-11
 0x00, 0x08, 0xFF, 0x03,  // Reg 12-15
 0x00, 0x24, 0x00, 0x00,  // Reg 16-19
 0x00, 0x01, 0x50, 0x30,  // Reg 20-23
 0x73, 0x04, 0x50, 0x08,  // Reg 24-27
 0x5A, 0x00, 0x82, 0x08,  // Reg 28-31
 0x08, 0x00, 0x47, 0x40,  // Reg 32-35
 0x00, 0x00, 0x00, 0x71,  // Reg 36-39
 0x00, 0x00, 0x08, 0x00,  // Reg 40-43
 0x00, 0x00, 0x00, 0x01,  // Reg 44-47
 0x00, 0x00, 0x00, 0x00   // Reg 48-51
};
```

---

## 寄存器详细说明

### 寄存器 0 (0x1D) - IIC地址与低频时钟配置
- **I2C_A[1:0]**: IIC设备地址配置
- **OLF_CTUNE[3:0]**: 低频时钟粗调（0~15）
- **OLF_FTUNE**: 低频时钟微调

| OLF_CTUNE | OLF_FTUNE | 频率 |
|-----------|-----------|------|
| 11 (10kHz) | 0001 | 5 kHz |
| 11 (10kHz) | 0111 | 10 kHz |
| 10 (50kHz) | 0000 | 28 kHz |
| 10 (50kHz) | 0011 | 48 kHz |
| 01 (100kHz) | 0100 | 100 kHz |
| 00 (200kHz) | 0101 | 200 kHz (推荐) |

---

### 寄存器 1 (0x00) - 外部晶振时钟OX配置
- **OX_DIS**: 禁用OX时钟
  - 0 = 启用
  - 1 = 禁用
- **OX_DIV4**: 时钟4分频
  - 0 = 不分频
  - 1 = 4分频
- **OX_RUN[1:0]**: 运行模式与延迟
  - 000 = 关闭OX时钟
  - 001 = OX正常运行
  - 010 = OX延迟31/低频时钟频率
  - 011 = OX延迟2/低频时钟频率
  - 110 = OX延迟1/低频时钟频率

---

### 寄存器 2 (0x58) - 端口放电电阻配置
- **RDCHG_INT_1[1:0]**: PC4~PC5的放电电阻
  - 00 = 180 kΩ
  - 01 = 90 kΩ
  - 10 = 30 kΩ
  - 11 = 10 kΩ
- **RDCHG_INT_0[1:0]**: PC0~PC3, PC6的片上放电电阻
  - 00 = 180 kΩ
  - 01 = 90 kΩ
  - 10 = 30 kΩ
  - 11 = 10 kΩ
- **RDCHG_INT_EN**: 内部放电电阻使能
  - 0 = 关闭
  - 1 = 启用
- **RDCHG_EXT_EN**: 外部放电电阻使能
  - 0 = 关闭
  - 1 = 启用

---

### 寄存器 3 (0x10) - 端口充放电电阻配置
- **AUX_PD_DIS**: 取消内部下拉电阻（PC_AUX）
  - 0 = 启用
  - 1 = 禁用
- **AUX_CINT**: 连接内部电容转换期间到端口PCAUX
  - 0 = 断开（默认）
  - 1 = 内部电容期间连接
- **RDCHG_PERM_EN**: 启用芯片内部放电电阻永久连接
  - 0 = 断开连接（默认）
  - 1 = 连接
- **RDCHG_EXT_PERM**: 启用外部放电电阻
  - 0 = 断开（默认）
  - 1 = 连接
- **RCHG_SEL[1:0]**: 选择充电电阻
  - 00 = 180 kΩ
  - 01 = 10 kΩ

---

### 寄存器 4 (0x10) - 端口电容连接方式
- **C_REF_INT**: 在PC0/GND或PC0/PC1使用片上参比电容
  - 0 = 外部参比电容（PC0/GND或PC0/PC1）
  - 1 = 内部参比电容
- **C_COMP_EXT**: 启用芯片外部电容的补偿功能
  - 0 = 禁用
  - 1 = 启用
- **C_COMP_INT**: 启用片上寄生电容的补偿（控制补偿算法）
  - 0 = 禁用
  - 1 = 启用
- **C_DIFFERENTIAL**: 在单端测量和差分测量之间选择
  - 0 = 单端测量
  - 1 = 差分测量
- **C_FLOATING**: 选择接地测量或浮动测量
  - 0 = 接地测量
  - 1 = 浮动测量

---

### 寄存器 5 (0x00) - 定时器配置
- **CY_PRE_MR1_SHORT**: 缩短内部时间路径之间延迟
  - 0 = 标准（推荐）
  - 1 = 缩短
- **C_PORT_PAT**: 测试端口的顺序（每个都有高低）
  - 0 = 禁用
  - 1 = 顺序测试每个端口的顺序高低
- **CY_HFCLK_SEL**: 选择CDC的时钟源
  - 0 = OLF_CLK
  - 1 = OHF_CLK
- **CY_DIV4_DIS**: 改变时间周期
  - 0 = 分频
  - 1 = 4时钟周期
- **CY_PRE_LONG**: 增加内部时间路径之间的安全延迟
  - 0 = 关闭
  - 1 = 启用
- **C_DC_BALANCE**: 差分测量的直流状态（正负电容连接到高或正）
  - 0 = 关闭

---

### 寄存器 6 (0x0F/0x3F) - 测量端口使能配置
- **C_PORT_EN[7:0]**: 位使能CDC端口

| 位值 | 端口 |
|------|------|
| 0x00 | 全部关闭 |
| 0x01 | PC0 |
| 0x02 | PC1 |
| 0x04 | PC2 |
| 0x08 | PC3 |
| 0x10 | PC4 |
| 0x20 | PC5 |
| 0x40 | PC6 |
| 0x80 | PC7 |
| 0x0F | PC0~PC3（4通道） |
| 0x3F | PC0~PC5（6通道，全部端口） |

**说明**: PC0~PC3为4位，PC4~PC7为4位，可打开多通道叠加计算
- 例如：PC0+PC1 = 0x01+0x02 = 0x03
- 例如：PC0+PC1+PC3 = 0x01+0x02+0x08 = 0x0B

---

### 寄存器 7-8 (0x20, 0x00) - 采样平均配置
- **C_AVRG[11:0]**: 从寄存器7开始的12位，设置一次平均采样数（可以增加精度）
  - 0 or 1 = 不平均
  - 2 = 2次采样平均
  - 3 = 3次采样平均
  - ...
  - 8191 = 最大采样取平均

**当前配置**: 0x0020 = 32次平均

---

### 寄存器 9-11 (0xD0, 0x07, 0x00) - 转换时间配置
- **CONV_TIME**: 转换周期或测量周期
  - 公式：`Tcon = 2 * CONV_TIME / fOLF`
  - Tcon必须小于等于测量周期

**当前配置**: 0x0007D0 = 2000（十进制）
- 如果OLF = 200kHz，则 Tcon = 2 × 2000 / 200000 = 20ms

---

### 寄存器 12 (0x00) - 放电时间配置
- **DISCHARGE_TIME[7:0]**: 在CDC放电时间T放电
  - 公式：`Tdischarge = (DISCHARGE_TIME + 1) × Tcycleclock`
  - 0 = Tdischarge = 1 × Tcycleclock

---

### 寄存器 13 (0x08) - GPIO3触发/测试触发CDC启动配置
- **C_STARTONPIN[1:0]**: 选择哪个通过硬件启动CDC的GPIO端口
  - 00 = PG0
  - 01 = PG1
  - 10 = PG2
  - 11 = PG3
- **C_TRIG_SEL[2:0]**: 选择自由运行CDC的触发源
  - 000 = 连续模式
  - 001 = 已存储待取
  - 010 = 定时器触发
  - 011 = 定时器触发（推荐）
  - 011 = GPIO触发触发（硬件触发）
  - 011 = 连续模式（推荐）

---

### 寄存器 14 (0xFF) - 预充电时间配置
- **PRECHARGE_TIME[9:0]**: 在CDC放电时间
  - 公式：`Tprecharge = (PRECHARGE_TIME + 1) × Tcycleclock`
  - OHF & FULLCHARGE_TIME = 1023: `Tprecharge = (PRECHARGE_TIME + 2) × Tcycleclock`
  - OLF & FULLCHARGE_TIME != 0x3FF: `Tprecharge = (PRECHARGE_TIME + 1) × Tcycleclock`
  - 1023 = 关闭

**当前配置**: 0xFF = 255（最大预充电时间）

---

### 寄存器 15 (0x03) - 预测补偿配置
- **C_FAKE[3:0]**: 真实测量前的预热假测量（重要，需要寄存器设置为0）
- **PRECHARGE_TIME**: 详见寄存器14

---

### 寄存器 16 (0x00) - 满充电时间配置
- **FULLCHARGE_TIME[9:0]**: 从27开始，28的2位，10位满充电时间
  - OLF: `Tfullcharge = (FULLCHARGE_TIME + 1) × Tcycleclock`
  - OHF: `Tfullcharge = (FULLCHARGE_TIME + 2) × Tcycleclock`

---

### 寄存器 17 (0x24) - 内部参考电容大小
- **C_REF_SEL[4:0]**: 内部参考电容大小（相对0.3pF~1.5pF，相比较低）
  - 0D0~0D31 = 0~31 

**当前配置**: 0x24 = 36（十进制）= 约36pF

---

### 寄存器 18-19 (0x00, 0x00) - 增益功能配置
详细的增益放大器配置（未启用）

---

### 寄存器 20 (0x00) - RDC时间配置
- **R_CY**: RDC测定的循环时间

| OLF频率 | R_CY=0 | R_CY=1 |
|---------|--------|--------|
| 10 kHz | 100 μs | 200 μs |
| 50 kHz | 20 μs | 40 μs |
| 100 kHz | 10 μs | 20 μs |
| 200 kHz | 20 μs | 40 μs |

---

### 寄存器 21 (0x01) - 预分频配置
- **R_TRIG_PREDIV**: 预分频，用于比电容测量慢的温度测量（CDC与RDC的测量之间连接）
  - 0 or 1 = 每一次CDC测量后触发
  - 2 = 每两次CDC测量后触发
  - ...
  - 最多2^21次分频

---

### 寄存器 22 (0x50) - RDC触发选择
- **R_TRIG_SEL[2:0]**: 控制RDC触发源选择
  - 0 = 关闭
  - 1 = 定时器触发
  - 3 = 测量触发
  - 5 = CDC异步（推荐）
  - 6 = CDC同步
- **R_AVRG[1:0]**: RDC测定的平均值配置
  - 00 = 不平均
  - 01 = 4次平均
  - 10 = 8次平均
  - 11 = 16次平均

---

### 寄存器 23 (0x30) - 参考配置与温度传感器
- **r_port_en[1:0]**: RDC测定的端口寄生器
  - 00 = 禁用内部参考
  - 01 = 启用端口PT0REF
  - 10 = 使用内部参考
  - 11 = 启用端口PT1
- **R_PORT_EN_IMES**: 内部芯片温度传感器的端口寄生
  - 0 = 禁用内部温度传感器
  - 1 = 使用内部温度传感器
- **r_port_en_iref**: 内部参考电流的端口寄生
  - 0 = 禁用内部电流
  - 1 = 使用内部电流
- **R_FAKE**: 真实测量前的预热假测量数量
  - 0 = 每次平均有2次假测量
  - 1 = 每次平均有8次假测量
- **R_STARTONPIN[1:0]**: 选择启动RDC的GPIO端口
  - 0 = PG0
  - 1 = PG1
  - 2 = PG2
  - 3 = PG3

---

### 寄存器 24-26 (0x73, 0x04, 0x50) - TDC配置
这些寄存器为芯片内部固定配置（Time-to-Digital Converter）

---

### 寄存器 27 (0x08) - DSP配置
- **DSP_MOFLO_EN[1:0]**: GPIO输出数据使能的动态范围溢出
  - 00 = 关闭
  - 11 = 启用
- **DSP_SPEED[1:0]**: DSP速度配置
  - 00 = 慢速
  - 01 = 中速（推荐）
  - 10 = 快速
  - 11 = 极快
- **PG1xPG3**: PDM/PWM输出引脚为PG3或PG1
  - 0 = PG3
  - 1 = PG1
- **PG0xPG2**: PDM/PWM输出引脚为PG2或PG0
  - 0 = PG2
  - 1 = PG0

---

### 寄存器 28 (0x5A) - 看门狗配置
- **WD_DIS**: 要禁用看门狗，0x5A必须被写入该寄存器
  - 0x5A = 看门狗禁用（关闭）
  - 0x00 = 推荐/启用（看门狗启用）

**当前配置**: 0x5A = 看门狗已禁用

---

### 寄存器 29 (0x00) - DSP触发配置
- **DSP_STARTONPIN[3:0]**: 控制DSP启动触发
- **DSP_FF_IN[3:0]**: 滤波器寄存器

---

### 寄存器 30 (0x82) - 中断配置
- **PG5_INTN_EN**: 通过INTN信号控制PG5
  - 0 = PG5不受控
  - 1 = PG5 <== INTN
- **PG4_INTN_EN**: 通过INTN信号控制PG4
  - 0 = PG4不受控
  - 1 = PG4 <== INTN
- **DSP_START_EN**: DSP启动触发器
  - 0001 = 在接近时启动CDC
  - 0010 = 在RDC完成时启动（推荐）
  - 0100 = 定时器触发

---

### 寄存器 31-32 (0x08, 0x08) - 脉冲接口配置
PWM/PDM输出配置和分辨率设置

---

### 寄存器 33 (0x00) - GPIO配置
PG0~PG3的输入输出和上拉配置

---

### 寄存器 34 (0x47) - 带隙与自动启动配置
- **INT_TRIG_BG**: 读取触发带隙上电
  - 0 = 失效
  - 1 = 使能
- **DSP_TRIG_BG**: 上电刷新DSP位置置初值
  - 0 = 失效
  - 1 = 使能
- **BG_PERM**: 设置寄存器，如果使能BG_PERM=1，当前会增加功耗大约20μA
  - 0 = 上电待机模式
  - 1 = 上电待命
- **AUTOSTART**: 在上电或带隙启动后触发CDC
  - 0 = 失效
  - 1 = 启用（CDC自动启动）

---

### 寄存器 35 (0x40) - 增益缩放因子
- **AUTOSTART**: 固件寄生电容数值，增益缩放因子（8fpp中的0-7位）
  - 0x00 = 0
  - 0xN = 1 + N/256
  - 推荐使用 1.25 ==> 0x40

---

### 寄存器 36-38 (0x00) - 未使用
保留寄存器

---

### 寄存器 39-43 - 固件配置
脉冲选择和传感器选择配置

---

### 寄存器 47-48 - 运行位与内存锁
系统控制和NVRAM安全功能

---

### 寄存器 49-50 - 序列号
芯片序列号（低字节和高字节）

---

### 寄存器 51-53 - 芯片内部固定配置

---

### 寄存器 54 (0x00) - 内存控制
- **MEM_CTRL**: 内存控制
  - 0x2d = 存储到NVRAM存储器
  - 0x59 = NVRAM召回重新加载
  - 0xb8 = NVRAM从寄存器加载（SIF立即自动完成）

---

### 寄存器 55-61 - 芯片内部固定配置

---

### 寄存器 62-63 (0x00) - 电荷泵配置
NVRAM编程高压电荷泵配置

---

## 推荐配置说明

### 当前使用的配置 (PCAP04_Config)
- **时钟频率**: 200kHz（低频时钟）
- **测量端口**: PC0~PC5（6通道，0x3F）
- **平均次数**: 32次（提高精度）
- **转换时间**: 20ms（基于200kHz时钟）
- **看门狗**: 已禁用（0x5A）
- **参考电容**: 36pF（内部参考）
- **触发模式**: 连续模式/定时器触发

---

## 注意事项
1. 每次修改配置寄存器后，建议调用 `NV_STORE` (0x96) 将配置存储到非易失性存储器
2. 修改时钟配置后需要重新初始化芯片
3. 增加平均次数可以提高测量精度，但会降低测量速度
4. 根据实际电容范围调整参考电容大小（C_REF_SEL）

---

## 相关函数
- `PCap04_Init()`: 基本初始化（使用PCAP04_Config）
- `PCap04_Init_Tow()`: 完整初始化（包含固件写入）
- `PCAP04_Read_CDC_Result_data()`: 读取CDC测量结果
- `integrated_data()`: 将原始数据转换为实际电容值

---

## 参考资料
- PCAP04 数据手册
- 固件版本: 1024字节（PCAP04_Firmware数组）

**文档版本**: 1.0
**最后更新**: 2025

