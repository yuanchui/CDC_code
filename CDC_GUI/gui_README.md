# PCap04 USB CDC GUI 监控系统

基于 Python PyQt5 开发的 PCap04 16x16 电容矩阵监控图形界面应用程序。

## 功能特性

### 核心功能
- ✅ USB 2.0 CDC 串口通信（双线程双缓冲）
- ✅ 实时显示 16x16 电容矩阵
- ✅ 收发消息日志显示
- ✅ 所有 USB 命令发送和接收
- ✅ 量化输出模式设置
- ✅ 颜色映射显示（根据数值显示颜色）
- ✅ 单点追踪功能
- ✅ 点击矩阵点显示变化趋势
- ✅ SQLite 数据库存储（非阻塞线程）

### 技术特性
- **双线程架构**：接收线程和主线程分离，确保不阻塞UI
- **双缓冲机制**：接收缓冲区和处理缓冲区交换，提高数据处理效率
- **非阻塞数据库**：使用独立线程和队列机制，不影响实时显示
- **实时可视化**：矩阵颜色映射、趋势图表实时更新

## 环境要求

- Python 3.7+
- PyQt5 5.15+
- pyserial 3.5+
- matplotlib 3.8+
- numpy 1.26+

## 安装

1. 安装依赖：
```bash
pip install -r requirements.txt
```

## 使用方法

1. 运行程序：
```bash
python main.py
```

2. 连接设备：
   - 点击"刷新端口"扫描可用串口
   - 选择对应的 COM 口
   - 点击"连接"按钮

3. 使用功能：
   - **矩阵显示**：实时显示16x16电容矩阵，颜色反映数值大小
   - **命令发送（建议流程）**：
     1) 点击“开始”发送 `START` 开启会话（设备会回复 START）
     2) 选择 `NORMAL_MODE`（配合 `SET_RATE:<ms>`）或 `FAST_MODE` 开始连续传输
     3) 需要结束时点击“停止”（发送 `STOP`，设备会回复 END）
   - **单点追踪**：点击矩阵中的单元格，自动追踪该点的变化
   - **趋势显示**：追踪点的历史数据以图表形式显示

## 界面说明

### 主界面布局

```
┌─────────────────────────────────────────────────┐
│  USB连接控制  │  输出模式控制                    │
├─────────────────────────────────────────────────┤
│                                                 │
│  16x16 矩阵显示 (颜色映射)                       │
│                                                 │
│  单点追踪趋势图                                  │
│                                                 │
├─────────────────────────────────────────────────┤
│  命令面板  │  消息日志                           │
└─────────────────────────────────────────────────┘
```

### 输出模式

- **原始值模式 (RAW)**：显示从设备读取的原始电容值
- **量化模式 (QUANT)**：将原始值量化到设定范围
  - 设置最小值 (L) 和最大值 (H)
  - 选择档位：0-255 或 0-1023

### 颜色映射

矩阵单元格根据数值大小显示不同颜色：
- **蓝色**：低值
- **青色 → 绿色**：中低值
- **黄色 → 红色**：高值

## USB 命令支持

程序支持所有设备端实现的命令（与固件对齐）：

- `START` - 开启会话（设备先回显 START，再允许传输）
- `SET_RATE:<ms>` - 设置扫描速率
- `FAST_MODE` - 快速模式
- `NORMAL_MODE` - 普通模式
- `SINGLE_SCAN` - 单次扫描
- `STOP` - 停止扫描
- `STATUS` - 查询状态
- `SET_ROW:<n>` - 设置行通道
- `SET_COL:<n>` - 设置列通道
- `SCAN_POINT:<r>:<c>` - 扫描指定点（固件侧会自动用 START/END 包围输出）
- `SET_MODE:<raw|quant>` - 设置输出模式
- `SET_RANGE:<min>:<max>` - 设置量化范围
- `SET_LEVEL:<255|1023>` - 设置量化档位
- `SET_FORMAT:<simple|table>` - 设置输出格式（逐点或表格）

## 数据存储

- **数据库文件**：`pcap04_data.db` (SQLite)
- **存储内容**：每个点的历史数据（时间戳、行列、数值）
- **存储方式**：非阻塞线程，使用队列缓冲

## 项目结构

```
CDC_GUI/
├── main.py                    # 程序入口
├── requirements.txt           # 依赖列表
├── README.md                  # 本文件
├── gui/                       # GUI模块
│   ├── main_window.py        # 主窗口
│   ├── matrix_widget.py      # 矩阵显示组件
│   ├── message_log.py        # 消息日志组件
│   ├── command_panel.py      # 命令面板组件
│   └── trend_chart.py        # 趋势图表组件
├── communication/             # 通信模块
│   └── serial_communication.py  # 串口通信（双线程双缓冲）
└── database/                  # 数据库模块
    └── database_manager.py    # 数据库管理（非阻塞）
```

## 注意事项

1. **串口权限**：Linux/Mac 可能需要串口权限
2. **波特率**：默认115200，根据设备配置调整
3. **数据解析**：程序会自动解析设备发送的矩阵数据格式
4. **性能优化**：大数据量时，消息日志会自动限制行数防止内存溢出

## 开发说明

### 双线程双缓冲机制

1. **接收线程**：专门负责从串口读取数据，放入接收缓冲区
2. **主线程**：定期交换缓冲区，处理数据并更新UI
3. **双缓冲**：使用两个缓冲区（接收缓冲和处理缓冲）避免数据丢失

### 非阻塞数据库存储

1. **数据队列**：使用 Queue 缓冲待存储的数据
2. **存储线程**：独立线程处理数据库写入
3. **非阻塞**：数据写入不影响UI响应

## 许可证

请参考项目许可证。

---

**版本**: 1.1.0  
**最后更新**: 2025年

## 快速打包（单文件可执行，无需解压）

在 Windows 下，一键打包为单文件 EXE：

1. 进入 `CDC_GUI` 目录，确保已创建本目录自带的虚拟环境并安装依赖：
```bash
python -m venv venv
venv\Scripts\pip install -r requirements.txt
```
2. 运行打包脚本（自动安装 PyInstaller 并生成单文件 EXE）：
```bash
package.bat
```
3. 生成的可执行文件位置：`CDC_GUI\dist\PCap04_GUI.exe`
   - 双击即可运行，无需解压或额外依赖。

注意：首次运行单文件 EXE 会进行必要的初始化，之后可直接打开使用。

## 使用 Nuitka 打包（分散文件，无需解压）

如果你希望生成“分散文件”的独立目录（非单文件 EXE，启动更快，便于杀软误报规避）：

1. 进入 `CDC_GUI` 目录并准备本地虚拟环境：
```bash
python -m venv venv
venv\Scripts\pip install -r requirements.txt
```
2. 运行 Nuitka 打包脚本（自动安装 Nuitka）：
```bash
package_nuitka.bat
```
3. 生成输出目录：`CDC_GUI\PCap04_GUI.dist\`
   - 运行其中的 `PCap04_GUI.exe` 即可（该目录内包含所有依赖文件）。

说明：脚本启用 `--standalone` 与 `--enable-plugin=pyqt5`，并自动包含 `command_config.json` 与 `app.ico`。

